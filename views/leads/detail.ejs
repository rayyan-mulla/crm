<% function displaySource(source) { 
    const map = {
      google_sheet: 'Google Sheets',
      meta: 'Meta',
      indiamart: 'IndiaMART',
      manual: 'Manual Entry',
      excel_upload: 'Excel Upload'
    };
    return map[source] || source;
} %>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lead Detail - Olive Chairs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    /* Left column boxes */
    :root {
      /* Adjust this if your header/breadcrumbs get taller/shorter */
      --lead-panels-offset: 150px;
    }

    .lead-panels-row {
      /* The entire row is now a fixed-height area */
      height: calc(100vh - var(--lead-panels-offset));
      min-height: 420px; /* safety floor for short viewports */
    }

    /* Make both columns fill that height */
    .lead-left, .lead-right { height: 100%; min-height: 0; }

    /* Left column: stack Notes and Status evenly and allow them to scroll */
    .lead-left {
      display: grid;
      grid-template-rows: 1fr 1fr;  /* 50/50 split */
      gap: .5rem;
    }

    /* Ensure cards and bodies can shrink so inner areas can scroll */
    .lead-panels-row .card { height: 100%; min-height: 0; }
    .lead-panels-row .card-body { display: flex; flex-direction: column; min-height: 0; }

    /* Scrollable inner boxes */
    .scroll-box,
    .status-box,
    .chat-box { overflow-y: auto; }

    /* Chat area should flex and scroll without pushing the column taller */
    .chat-box {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
      min-height: 0; /* important for flex children */
      flex: 1 1 auto;
      overflow-y: auto;
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
    }

    #mediaPreviewWrapper {
      position: absolute;
      bottom: 100%; /* Sits exactly above the input bar */
      left: 10px;
      right: 10px;
      z-index: 10;
      background: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 8px 8px 0 0; /* Rounded top corners */
      box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
      transition: all 0.2s ease-in-out;
    }

    /* Container for the form to keep the preview relative to it */
    .whatsapp-input-container {
      position: relative; 
      background: white;
      padding: 10px;
      border-top: 1px solid #eee;
    }

    .chat-msg {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 75%;
      word-wrap: break-word;
    }
    .chat-msg.sent { background: #d1e7dd; margin-left: auto; }
    .chat-msg.received { background: #e2e3e5; margin-right: auto; }

    /* Tweak small badge */
    /* Keep the whole active row on one line and truncate long value */
    .active-for-sending {
      display: flex;
      gap: .5rem;
      align-items: center;
      flex-wrap: nowrap;        /* critical: prevent wrapping */
      white-space: nowrap;      /* treat text as one line */
      overflow: hidden;         /* hide overflow */
    }

    /* Badge that truncates its inner text */
    .badge-active-number {
      display: inline-block;
      max-width: 60%;           /* adjust as needed (60% of container) */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;  /* show "..." for long values */
      vertical-align: middle;
    }

    /* Ensure card bodies stretch */
    .row.align-items-stretch { align-items: stretch; }
    .card.h-100 { height: 100%; }
    .card-body.d-flex.flex-column { display:flex; flex-direction:column; }
  </style>
</head>
<body>
<%- include('../partials/navbar', { user, activePage }) %>
<div class="container py-4">

  <!-- Lead Info -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 fw-bold text-dark">
          <i class="bi bi-person-circle me-2 text-secondary"></i>
          <%= lead.customer_name %>
        </h4>
        <span class="badge bg-light text-dark border"><%= lead.status %></span>
      </div>

      <div class="row g-4">
        <!-- Contact Info + Date -->
        <div class="col-md-6">
          <div class="mb-3">
            <small class="text-muted d-block">Date</small>
            <span><%= lead.date ? new Date(lead.date).toLocaleDateString() : '-' %></span>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block">Assigned To</small>
            <span><%= lead.assignedTo ? lead.assignedTo.fullName : '‚Äî' %></span>
          </div>
          
          <div class="mb-3">
            <small class="text-muted d-block">Phone</small>
            <div class="d-flex align-items-center">
              <span class="me-3"><%= lead.contact_number %></span>
              <% if (lead.contact_number) { %>
                <a href="tel:<%= lead.contact_number %>" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-telephone"></i> Call
                </a>
              <% } %>
            </div>
          </div>

          <!-- NEW: Alternate Number (right after the Phone block) -->
          <div class="mb-3">
            <small class="text-muted d-block">Alternate Phone</small>
            <% if (lead.canEdit) { %>
              <div id="display-alt-phone" class="<%= lead.alternate_number ? 'd-flex' : 'd-none' %> align-items-center">
                <span class="me-3"><%= lead.alternate_number %></span>
                <button class="btn btn-sm btn-outline-primary" onclick="toggleEdit('alt-phone')">Edit</button>
              </div>
              <form id="form-alt-phone" action="/leads/<%= lead._id %>/alternate-number" method="post" 
                    class="<%= lead.alternate_number ? 'd-none' : 'd-flex' %> align-items-center">
                <input type="text" name="alternate_number" class="form-control form-control-sm me-2" 
                      style="max-width: 200px;" value="<%= lead.alternate_number || '' %>" placeholder="Enter number">
                <button class="btn btn-success btn-sm me-1">Save</button>
                <% if (lead.alternate_number) { %>
                  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleEdit('alt-phone')">Cancel</button>
                <% } %>
              </form>
            <% } else { %>
              <span><%= lead.alternate_number || '‚Äî' %></span>
            <% } %>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block">Email</small>
            <div class="d-flex align-items-center">
              <span class="me-3"><%= lead.email_id || '‚Äî' %></span>
              <% if (lead.email_id) { %>
                <a href="mailto:<%= lead.email_id %>" class="btn btn-sm btn-outline-secondary">
                  <i class="bi bi-envelope"></i> Draft
                </a>
              <% } %>
            </div>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block">City</small>
            <span><%= lead.city || '‚Äî' %></span>
          </div>
        </div>

        <!-- Meta Info (source, requirement, assigned, etc.) -->
        <div class="col-md-6">
          <div class="mb-3">
            <small class="text-muted d-block">Source</small>
            <span class="fw-semibold text-dark">
              <%= displaySource(lead.source) %>
              <% if (lead.sourceMeta && (lead.sourceMeta.byUser || lead.sourceMeta.importedAt || lead.sourceMeta.uploadedAt || lead.sourceMeta.createdAt)) { %>
                <small class="text-muted">
                  (
                  <% if (lead.sourceMeta.byUser) { %>
                    by <%= lead.sourceMeta.byUser %>
                  <% } %>
                  <% const sourceDate = lead.sourceMeta.importedAt || lead.sourceMeta.uploadedAt || lead.sourceMeta.createdAt; %>
                  <% if (sourceDate) { %>
                    on <%= new Date(sourceDate).toLocaleString() %>
                  <% } %>
                  )
                </small>
              <% } %>
            </span>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block">Lead Source</small>
            <span class="d-inline-block text-truncate" style="max-width: 100%;" title="<%= lead.leadSource || '' %>">
              <%= lead.leadSource || '‚Äî' %>
            </span>
          </div>
          
          <div class="mb-3">
            <small class="text-muted d-block">Customer Type</small>
            <% if (lead.canEdit) { %>
              <div id="display-cust-type" class="<%= lead.customerType ? 'd-flex' : 'd-none' %> align-items-center">
                <span class="me-3"><%= lead.customerType %></span>
                <button class="btn btn-sm btn-outline-primary" onclick="toggleEdit('cust-type')">Edit</button>
              </div>
              
              <form id="form-cust-type" action="/leads/<%= lead._id %>/customer-type" method="post" 
                    class="<%= lead.customerType ? 'd-none' : 'd-flex' %> align-items-center">
                <select name="customerType" class="form-select form-select-sm me-2" style="max-width: 150px;">
                  <option value="End User" <%= lead.customerType === 'End User' ? 'selected' : '' %>>End User</option>
                  <option value="Reseller" <%= lead.customerType === 'Reseller' ? 'selected' : '' %>>Reseller</option>
                </select>
                <button class="btn btn-success btn-sm me-1">Save</button>
                <% if (lead.customerType) { %>
                  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleEdit('cust-type')">Cancel</button>
                <% } %>
              </form>
            <% } else { %>
              <span><%= lead.customerType || 'End User' %></span>
            <% } %>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block">Total Quantity</small>
            <% if (lead.canEdit) { %>
              <div id="display-qty" class="<%= lead.quantity ? 'd-flex' : 'd-none' %> align-items-center">
                <span class="me-3"><%= lead.quantity %> Units</span>
                <button class="btn btn-sm btn-outline-primary" onclick="toggleEdit('qty')">Edit</button>
              </div>
              <form id="form-qty" action="/leads/<%= lead._id %>/quantity" method="post" 
                    class="<%= lead.quantity ? 'd-none' : 'd-flex' %> align-items-center">
                <input type="number" name="quantity" class="form-control form-control-sm me-2" 
                      style="max-width: 120px;" value="<%= lead.quantity || '' %>" placeholder="Qty" min="0">
                <button class="btn btn-success btn-sm me-1">Save</button>
                <% if (lead.quantity) { %>
                  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleEdit('qty')">Cancel</button>
                <% } %>
              </form>
            <% } else { %>
              <span><%= lead.quantity || '‚Äî' %> Units</span>
            <% } %>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block">Requirement</small>
            <span class="d-inline-block text-truncate" style="max-width: 100%;" title="<%= lead.requirement || '' %>">
              <%= lead.requirement || '‚Äî' %>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Structured Requirement -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">Structured Requirement</h5>
        <%
          let totalDiff = 0;
        %>

      <% if (lead.normalizedRequirements?.length) { %>

        <ul class="list-group mb-3">

          <% lead.normalizedRequirements.forEach(req => { 
            const color = req.chair?.colors.find(
              c => c._id.toString() === req.colorId.toString()
            );
            if (!color) return;

            // ===== COST =====
            const costFinal = color.finalPrice;
            const costHasGst = color.gstApplicable === true;
            const costBase = costHasGst ? costFinal / 1.18 : costFinal;
            const shipping = req.shippingUnit || 0;
            const costPerUnitExclGst = costBase + shipping;

            // ===== SELLING =====
            const sellFinal = req.totalPrice;
            const sellHasGst = req.gstApplicable === true;
            const sellBase = sellHasGst ? sellFinal / 1.18 : sellFinal;
            const sellPerUnitExclGst = sellBase / req.quantity;

            // ===== RESULT =====
            const markupPerUnit = Math.round(
              sellPerUnitExclGst - costPerUnitExclGst
            );
            const totalMarkup = markupPerUnit * req.quantity;

            totalDiff += totalMarkup;
          %>

          <li class="list-group-item">

            <!-- HEADER -->
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="fw-bold fs-5">
                <%= req.chair.modelName %>
                <span class="text-muted fs-6">‚Äî <%= color.name %></span>
                <span class="badge bg-secondary ms-2">√ó <%= req.quantity %></span>
              </div>

              <% if (lead.canEdit) { %>
                <div class="d-flex gap-2">
                  <a
                    href="/leads/<%= lead._id %>/requirement/<%= req._id %>/edit"
                    class="btn btn-sm btn-outline-primary">
                    Edit
                  </a>

                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteRequirementModal"
                    data-lead-id="<%= lead._id %>"
                    data-req-id="<%= req._id %>"
                    data-title="<%= req.chair.modelName %> ‚Äî <%= color.name %>"
                  >
                    Delete
                  </button>
                </div>
              <% } %>
            </div>

            <!-- DETAILS -->
            <div class="small text-muted">

              <!-- COST -->
              <div>
                <strong class="text-dark">Cost (per unit)</strong><br>
                Base (excl GST): ‚Çπ<%= Math.round(costBase) %><br>
                GST: <%= costHasGst ? '‚úì 18%' : '‚Äî' %><br>
                Final (incl GST): ‚Çπ<%= costFinal %><br>
                Shipping: ‚Çπ<%= shipping %><br>
                ‚Üí Cost excl GST: ‚Çπ<%= Math.round(costPerUnitExclGst) %>
              </div>

              <hr class="my-2">

              <!-- SELLING -->
              <div>
                <strong class="text-dark">Selling</strong><br>
                GST: <%= sellHasGst ? '‚úì 18%' : '‚Äî' %><br>
                Invoice total (incl GST): ‚Çπ<%= sellFinal %><br>
                ‚Üí Selling excl GST: ‚Çπ<%= Math.round(sellBase) %><br>
                ‚Üí Per unit excl GST: ‚Çπ<%= Math.round(sellPerUnitExclGst) %>
              </div>

              <hr class="my-2">

              <!-- RESULT -->
              <div>
                <strong class="text-dark">Result</strong><br>
                Markup / unit:
                <span class="<%= markupPerUnit >= 0 ? 'text-danger' : 'text-success' %>">
                  ‚Çπ<%= markupPerUnit %>
                </span><br>
                Total Markup:
                <strong class="<%= totalMarkup >= 0 ? 'text-danger' : 'text-success' %>">
                  ‚Çπ<%= totalMarkup %>
                </strong>
              </div>

              <% if (req.note) { %>
                <div class="alert alert-warning py-2 mt-3">
                  <strong>Note:</strong> <%= req.note %>
                </div>
              <% } %>
            </div>
          </li>

          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">No structured requirement set yet.</p>
      <% } %>

      <!-- OVERALL MARKUP -->
      <div class="alert 
        <%= totalDiff > 0 
          ? 'alert-danger' 
          : (totalDiff < 0 ? 'alert-success' : 'alert-secondary') %>
        d-flex justify-content-between align-items-center">

        <span>
          Overall <%= totalDiff > 0 
            ? 'Markup' 
            : (totalDiff < 0 ? 'Discount' : 'No markup / discount') %>
        </span>

        <strong>‚Çπ<%= totalDiff %></strong>
      </div>

      <%
        const hasRequirements = lead.normalizedRequirements && lead.normalizedRequirements.length > 0;
      %>
      
      <!-- ACTIONS -->
      <div class="d-flex gap-2 mt-2">
        <!-- Add Requirement -->
        <a href="<%= lead.canEdit ? `/leads/${lead._id}/requirement/add` : 'javascript:void(0)' %>"
          class="btn btn-sm btn-success <%= !lead.canEdit ? 'disabled' : '' %>"
          <%= !lead.canEdit ? 'aria-disabled="true"' : '' %>>
          + Add Requirement
        </a>

        <!-- Generate PI -->
        <a href="<%= hasRequirements ? `/leads/${lead._id}/pi/create` : 'javascript:void(0)' %>"
          class="btn btn-sm btn-danger <%= !hasRequirements ? 'disabled' : '' %>"
          <%= !hasRequirements ? 'aria-disabled="true"' : '' %>>
          Generate Proforma Invoice
        </a>

        <!-- PI History -->
        <a href="<%= hasRequirements ? `/leads/${lead._id}/pi` : 'javascript:void(0)' %>"
          class="btn btn-sm btn-secondary <%= !hasRequirements ? 'disabled' : '' %>"
          <%= !hasRequirements ? 'aria-disabled="true"' : '' %>>
          Proforma Invoice History
        </a>
      </div>

      <% if (!lead.canEdit) { %>
        <div class="mt-2">
          <small class="text-muted">
            You can view this lead, but only the assigned user or an admin can add, edit, or delete requirements.
          </small>
        </div>
      <% } %>

      <% if (!hasRequirements) { %>
        <div class="mt-2">
          <small class="text-muted">
            Please add at least one requirement before generating a Proforma Invoice.
          </small>
        </div>
      <% } %>

    </div>
  </div>

  <!-- Assign & Status -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Assign Lead</h6>
          <% if (lead.canEdit) { %>
            <form action="/leads/<%= lead._id %>/assign" method="post" class="d-flex">
              <select name="userId" class="form-select me-2">
                <option value="">-- Assign User --</option>
                <% assignableUsers.forEach(u => { %>
                  <option value="<%= u._id %>" <%= lead.assignedTo && lead.assignedTo._id.toString() === u._id.toString() ? 'selected' : '' %>>
                    <%= u.fullName %> (<%= u.role %>)
                  </option>
                <% }) %>
              </select>
              <button class="btn btn-outline-primary">Assign</button>
            </form>
          <% } else { %>
            <p class="text-muted">Only admins or the assigned user can change assignment.</p>
          <% } %>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Update Status</h6>
          <% if (lead.canEdit) { %>
            <form action="/leads/<%= lead._id %>/status" method="post" class="d-flex align-items-center">
              <select name="status" id="statusSelect" class="form-select me-2" onchange="toggleCustomStatus()">
                <option value="">-- Update Status --</option>
                <% 
                  const adminStatuses = ["New","Assigned","In Progress","Deal Drop","Closed"];
                  const userStatuses = ["In Progress","Deal Drop","Closed"];
                  const statuses = user.role === 'admin' ? adminStatuses : userStatuses;
                %>

                <% statuses.forEach(s => { %>
                  <option value="<%= s %>" <%= lead.status===s ? 'selected' : '' %>><%= s %></option>
                <% }) %>
                <option value="__other__">Other...</option>
              </select>
              <input type="text" name="customStatus" id="customStatusInput" class="form-control me-2 d-none" placeholder="Enter custom status">
              <button class="btn btn-outline-success">Update</button>
            </form>
          <% } else { %>
            <p class="text-muted">Status updates are only available for the assigned user or admin.</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes + Status History (Left) | WhatsApp (Right) -->
  <div class="row gx-3 lead-panels-row">
    <div class="col-md-6 lead-left d-flex flex-column">
      <!-- Notes -->
      <div class="card shadow-sm mb-2 h-100 d-flex flex-column">
        <div class="card-body d-flex flex-column">
          <h5>Notes</h5>
          <% if (lead.canEdit) { %>
            <form action="/leads/<%= lead._id %>/note" method="post" class="d-flex mb-3">
              <input type="text" name="note" class="form-control me-2" placeholder="Add a note..." required>
              <button class="btn btn-primary">Add</button>
            </form>
          <% } else { %>
            <p class="text-muted">You can view notes, but only the assigned user or admin can add new ones.</p>
          <% } %>
          <div class="scroll-box flex-grow-1 overflow-auto mt-2">
            <% if (lead.notes.length) { %>
              <% lead.notes.slice().reverse().forEach(n => { %>
                <div class="border rounded p-2 mb-2 bg-light">
                  <%= n.text %>
                  <small class="text-muted d-block">
                    ‚Äî <%= n.user ? n.user.fullName : 'Unknown' %>, 
                    <%= new Date(n.createdAt).toLocaleString() %>
                  </small>
                </div>
              <% }) %>
            <% } else { %>
              <p class="text-muted">No notes yet</p>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Status History -->
      <div class="card shadow-sm h-100 d-flex flex-column">
        <div class="card-body d-flex flex-column">
          <h5>Status History</h5>
          <div class="status-box flex-grow-1 overflow-auto mt-2">
            <% if (lead.statusHistory.length) { %>
              <% lead.statusHistory.slice().reverse().forEach(h => { %>
                <div class="border rounded p-2 mb-2 bg-light">
                  <%= h.status %>
                  <small class="text-muted d-block">
                    ‚Äî <%= h.changedBy ? h.changedBy.fullName : 'Unknown' %>, 
                    <%= new Date(h.createdAt).toLocaleString() %>
                  </small>
                </div>
              <% }) %>
            <% } else { %>
              <p class="text-muted">No status updates yet</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- WhatsApp -->
    <div class="col-md-6 lead-right d-flex flex-column">
      <div class="card shadow-sm h-100 d-flex flex-column">
        <div class="card-body d-flex flex-column">
          <!-- Header with WhatsApp title -->
          <div class="d-flex flex-wrap justify-content-between align-items-start mb-2 gap-2">
            <h5 class="mb-0 w-md-auto">WhatsApp</h5>
            
            <div id="chat-timer-badge" class="mb-2 <%= canFreeChat ? '' : 'd-none' %> d-flex flex-wrap gap-2 w-md-auto">
  
              <span class="badge rounded-pill bg-success text-white px-3 py-2 shadow-sm" 
                    style="font-weight: 500; cursor: pointer;"
                    title="WhatsApp rules allow free chat for 24 hours after a customer's last message. After this, you must use a template.">
                <i class="bi bi-check-circle-fill me-1"></i>
                24h window active
              </span>

              <span class="badge rounded-pill bg-warning text-dark px-3 py-2 shadow-sm" 
                    style="font-weight: 500; cursor: pointer;"
                    title="WhatsApp rules allow free chat for 24 hours after a customer's last message. After this, you must use a template.">
                <i class="bi bi-clock-history me-1"></i>
                Remaining: <span id="countdown-timer" class="font-monospace">24:00:00</span>
              </span>

            </div>
          </div>

          <!-- Numbers row -->
          <div class="d-flex flex-column flex-xl-row mb-3 gap-2">
            <!-- From: Persisted (Set as Default button) -->
            <div class="flex-grow-1">
              <label class="small text-muted">From (default for sending)</label>
              <form action="/leads/<%= lead._id %>/whatsapp-number" method="post" class="d-flex align-items-center gap-2 flex-nowrap">
                <select name="whatsappNumberId" id="persistedFromSelect" class="form-select form-select-sm flex-grow-1">
                  <option value="">-- Select Number --</option>
                  <% whatsappNumbers.forEach(num => { %>
                    <option value="<%= num.phone_number_id %>" <%= lead.whatsappNumberId === num.phone_number_id ? 'selected' : '' %>>
                      <%= num.display_number %> (<%= num.label %>)
                    </option>
                  <% }) %>
                </select>
                <!-- Renamed button for clarity -->
                <button class="btn btn-outline-success btn-sm flex-shrink-0" title="Mark this WhatsApp number as the active sender">Save</button>
              </form>

              <!-- improved active-from badge -->
              <div class="mt-2 small active-for-sending">
                <span class="text-muted">Active for sending:</span>

                <% if (lead.whatsappNumberId) { 
                    const active = whatsappNumbers.find(n => n.phone_number_id === lead.whatsappNumberId);
                    const activeText = active ? (active.display_number + (active.label ? (' ‚Äî ' + active.label) : '')) : lead.whatsappNumberId;
                %>
                  <span
                    class="badge rounded-pill bg-primary text-white ms-1 badge-active-number"
                    title="<%= activeText %>">
                    <i class="bi bi-check-circle-fill me-1" aria-hidden="true"></i>
                    <%= activeText %>
                  </span>
                <% } else { %>
                  <span class="text-muted ms-1">Not set</span>
                <% } %>
              </div>
            </div>

            <!-- To: Filter only (dynamic) -->
            <div class="flex-grow-1">
              <label class="small text-muted">To</label>
              <form id="chatFilterForm" method="get">
                <select id="toNumberSelect" name="to" class="form-select form-select-sm" onchange="document.getElementById('chatFilterForm').submit()">
                  <% if (lead.contact_number) { %>
                    <option value="<%= lead.contact_number %>" <%= selectedTo === lead.contact_number ? 'selected' : '' %>>
                      <%= lead.contact_number %> (Primary)
                    </option>
                  <% } %>
                  <% if (lead.alternate_number) { %>
                    <option value="<%= lead.alternate_number %>" <%= selectedTo === lead.alternate_number ? 'selected' : '' %>>
                      <%= lead.alternate_number %> (Alternate)
                    </option>
                  <% } %>
                </select>
              </form>
            </div>
          </div>
          <% if (!lead.whatsappNumberId) { %>
            <p class="text-muted">‚ö†Ô∏è Please assign a WhatsApp number to this lead before chatting.</p>
          <% } else { %>
            <div class="chat-box">
              <% if (chats.length) { %>
                <% chats.forEach(c => { %>
                  <div class="chat-msg <%= (c.direction === 'outbound' || c.type === 'template') ? 'sent' : 'received' %>">
                    
                    <% if (c.type === 'text') { %>
                      <%= c.content %>

                    <% } else if (c.type === 'template') { %>
                      üìë Sent template: <strong><%= c.content %></strong>

                    <% } else if (c.type === 'image') { %>
                      <% 
                        // Determine the source: use content (URL) if available, otherwise use media endpoint
                        const imgSrc = (c.content && c.content.startsWith('http')) ? c.content : `/whatsapp/media/${c.mediaId}`;
                      %>
                      <a href="<%= imgSrc %>" target="_blank">
                        <img src="<%= imgSrc %>" alt="Image" style="max-width:200px; border-radius:8px; display:block; margin-bottom:5px;">
                      <% if (c.caption) { %><div><%= c.caption %></div><% } %>
                      </a>

                    <% } else if (c.type === 'document') { %>
                      <% 
                        const docLink = (c.content && c.content.startsWith('http')) ? c.content : `/whatsapp/media/${c.mediaId}`;
                      %>
                      <div class="d-flex align-items-center border p-2 rounded bg-light">
                        <i class="bi bi-file-earmark-arrow-down fs-4 me-2"></i>
                        <a href="<%= docLink %>" target="_blank" class="text-decoration-none">
                          <%= c.filename || 'Download Document' %>
                        </a>
                      </div>
                      <% if (c.caption) { %><div class="mt-1 small"><%= c.caption %></div><% } %>

                    <% } else if (c.type === 'audio') { %>
                      <audio controls style="width:100%;">
                        <source src="<%= (c.content && c.content.startsWith('http')) ? c.content : `/whatsapp/media/${c.mediaId}` %>" type="audio/mpeg">
                      </audio>

                    <% } else { %>
                      [<%= c.type %>]
                    <% } %>

                    <div class="small text-muted mt-1" style="font-size: 0.7rem;">
                      <%= new Date(c.timestamp).toLocaleString('en-IN', { 
                          day: '2-digit', 
                          month: '2-digit', 
                          year: 'numeric', 
                          hour: '2-digit', 
                          minute: '2-digit', 
                          hour12: true 
                      }) %>
                    </div>
                  </div>
                <% }) %>
              <% } else { %>
                <p class="text-muted">No messages yet</p>
              <% } %>
            </div>

            <% if (lead.canEdit) { %>
              
                <div class="whatsapp-input-container">
                  <div id="free-chat-area" class="<%= canFreeChat ? '' : 'd-none' %>">
                    <form action="/leads/<%= lead._id %>/whatsapp/send-text"
                          method="post"
                          enctype="multipart/form-data"
                          onsubmit="syncToNumber(this)">

                        <div id="mediaPreviewWrapper" class="d-none p-2">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <img id="imagePreview" src="#" class="d-none" style="height: 50px; width: 50px; object-fit: cover; border-radius: 4px;">
                                    <div id="docPreview" class="d-none align-items-center">
                                        <i class="bi bi-file-earmark-text fs-3 text-primary"></i>
                                    </div>
                                    <div class="ms-2">
                                        <div id="fileNameDisplay" class="small fw-bold"></div>
                                        <small class="text-muted">Ready to send</small>
                                    </div>
                                </div>
                                <button type="button" 
                                  class="btn-close" 
                                  onclick="clearAttachment()" 
                                  style="position: absolute; top: 8px; right: 8px; width: 0.5rem; height: 0.5rem; font-size: 0.6rem; box-shadow: none;"
                                >
                                </button>
                            </div>
                        </div>

                        <input type="hidden" name="to" class="hiddenToNumber">
                        <input type="hidden" name="mediaType" id="mediaTypeInput" value="text">

                        <div class="d-flex align-items-center gap-2">
                            <div class="dropdown">
                                <button class="btn btn-light rounded-circle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-plus-lg" style="-webkit-text-stroke: 0.8px; font-size: 1.1rem;"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                      <a class="dropdown-item" href="javascript:void(0)" onclick="triggerFilePicker('image')">
                                        <i class="bi bi-images text-primary me-2"></i>
                                        <span style="font-size: 0.85rem;">Image</span>
                                      </a>
                                    </li>
                                    <li>
                                      <a class="dropdown-item" href="javascript:void(0)" onclick="triggerFilePicker('document')">
                                        <i class="bi bi-file-earmark-text text-danger me-2"></i>
                                        <span style="font-size: 0.85rem;">Document</span>
                                      </a>
                                    </li>
                                </ul>
                            </div>

                            <input type="text" name="body" id="textInput" class="form-control rounded-pill" placeholder="Type a message‚Ä¶">

                            <button class="btn btn-success rounded-circle">
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>

                        <input type="file" name="mediaFile" id="imageInput" accept="image/*" class="d-none" onchange="handleFileSelect(this, 'image')">
                        <input type="file" name="mediaFile" id="documentInput" accept=".pdf,.doc,.docx,.xls,.xlsx" class="d-none" onchange="handleFileSelect(this, 'document')">
                    </form>
                  </div>
                </div>
              
                <div class="whatsapp-input-container">
                  <div id="template-area" class="<%= canFreeChat ? 'd-none' : '' %>">
                    <form action="/leads/<%= lead._id %>/whatsapp/send-text" method="post" onsubmit="syncToNumber(this)">
                      <input type="hidden" name="to" class="hiddenToNumber">
                      
                      <div class="d-flex align-items-center gap-2">
                        <div class="btn btn-light rounded-circle disabled" style="opacity: 1;">
                          <i class="bi bi-chat-quote-fill text-primary"></i>
                        </div>

                        <select name="templateName" class="form-select rounded-pill shadow-none" required style="border: 1px solid #dee2e6;">
                          <option value="">-- Select Template --</option>
                          <% whatsappTemplates.forEach(t => { %>
                              <option value="<%= t.name %>||<%= t.language %>">
                                  <%= t.name %> (<%= t.language %>)
                              </option>
                          <% }) %>
                        </select>

                        <button class="btn btn-success rounded-circle">
                          <i class="bi bi-send-fill"></i>
                        </button>
                      </div>
                    </form>
                    <p class="text-muted small mt-1 mb-0">
                      üí° A template message must be sent first. Once the user replies, you can chat freely for 24h.
                    </p>
                  </div>
                </div>
            <% } else { %>
              <p class="text-muted">You can view WhatsApp messages, but only the assigned user or admin can reply.</p>
            <% } %>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteRequirementModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <form id="deleteRequirementForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p>
            Are you sure you want to remove
            <strong id="deleteRequirementTitle"></strong>?
          </p>
          <p class="text-muted small mb-0">
            This action cannot be undone.
          </p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-danger">
            Yes, Delete
          </button>
        </div>
      </form>

    </div>
  </div>
</div>

<script>
  function toggleCustomStatus() {
    const select = document.getElementById('statusSelect');
    const input = document.getElementById('customStatusInput');
    if (select && input) {
      if (select.value === '__other__') {
        input.classList.remove('d-none');
        input.required = true;
      } else {
        input.classList.add('d-none');
        input.required = false;
      }
    }
  }

  function scrollChatToBottom() {
    const chatBox = document.querySelector('.chat-box');
    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
  }
  // Auto-scroll on load
  window.addEventListener('DOMContentLoaded', scrollChatToBottom);
</script>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  let countdownInterval;

  // join this lead‚Äôs room
  if ("<%= lead._id %>") {
    socket.emit('joinLeadRoom', "<%= lead._id %>");
  }

  // ‚úÖ NEW: Log the raw data received from the backend for debugging
  console.log("DEBUG: Initial Seconds from Server:", "<%= remainingSeconds %>");

  // 24h Timer Logic
  // ‚úÖ MODIFIED: Now accepts raw seconds instead of a date string
  function start24hTimer(secondsLeft) {
    if (secondsLeft <= 0) return;
    
    const timerDisplay = document.getElementById('countdown-timer');
    const timerBadge = document.getElementById('chat-timer-badge');
    const freeArea = document.getElementById('free-chat-area');
    const tempArea = document.getElementById('template-area');

    if (countdownInterval) clearInterval(countdownInterval);

    // ‚úÖ Target is set relative to the browser's CURRENT clock
    // This makes the timer immune to timezone settings
    const endTime = Date.now() + (parseInt(secondsLeft) * 1000);

    countdownInterval = setInterval(() => {
      const now = Date.now();
      const distance = endTime - now;
      const timeLeftSeconds = Math.floor(distance / 1000);

      if (timeLeftSeconds <= 0) {
        clearInterval(countdownInterval);
        // Clear UI and show templates
        if (timerBadge) timerBadge.classList.add('d-none');
        if (freeArea) freeArea.classList.add('d-none');
        if (tempArea) tempArea.classList.remove('d-none');
        if (timerDisplay) timerDisplay.innerHTML = "00:00:00";
        return;
      }

      // Standard formatting
      const h = Math.floor(timeLeftSeconds / 3600);
      const m = Math.floor((timeLeftSeconds % 3600) / 60);
      const s = Math.floor(timeLeftSeconds % 60);
      
      if (timerDisplay) {
        timerDisplay.innerHTML = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
      }
    }, 1000);
  }

  // Initial Timer Check
  // ‚úÖ MODIFIED: Using the pre-calculated remainingSeconds from backend
  const initialSeconds = parseInt("<%= remainingSeconds %>") || 0;
  const canFreeChatServer = "<%= canFreeChat %>" === "true";

  if (canFreeChatServer && initialSeconds > 0) {
      // Start timer using the accurate backend calculation
      start24hTimer(initialSeconds);
  } else if (canFreeChatServer && initialSeconds <= 0) {
      // If server logic says window is open but seconds are 0, force lock the UI
      if (document.getElementById('free-chat-area')) document.getElementById('free-chat-area').classList.add('d-none');
      if (document.getElementById('template-area')) document.getElementById('template-area').classList.remove('d-none');
      if (document.getElementById('chat-timer-badge')) document.getElementById('chat-timer-badge').classList.add('d-none');
  }
  
  socket.on('newMessage', (msg) => {
    console.log("üì© New message arrived", msg);

    const chatBox = document.querySelector('.chat-box');
    if (!chatBox) return;

    // If message is inbound, UNLOCK the free chat UI instantly
    if (msg.direction === 'inbound') {
      const freeArea = document.getElementById('free-chat-area');
      const tempArea = document.getElementById('template-area');
      const timerBadge = document.getElementById('chat-timer-badge'); 
      if (freeArea && tempArea) {
        freeArea.classList.remove('d-none');
        tempArea.classList.add('d-none');
        if (timerBadge) timerBadge.classList.remove('d-none'); 
        // ‚úÖ Reset timer to a fresh 24 hours (86400 seconds)
        start24hTimer(86400); 
      }
    }

    const div = document.createElement('div');
    div.className = 'chat-msg ' + (msg.direction === 'outbound' ? 'sent' : 'received');

    let contentHtml = '';

    // ‚úÖ TEXT
    if (msg.type === 'text') {
      contentHtml = `<div>${msg.content}</div>`;
    }

    // TEMPLATE
    else if (msg.type === 'template') {
      contentHtml = `<div>üìë Sent template: <strong>${msg.content}</strong></div>`;
    }

    // üñº IMAGE
    else if (msg.type === 'image') {
      const imageUrl = msg.content; 
      contentHtml = `
        <a href="${imageUrl}" target="_blank">
          <img src="${imageUrl}"
              style="max-width:200px; border-radius:8px; display:block; margin-bottom:5px;"
              onerror="this.src='/img/placeholder-error.png'; this.parentElement.innerText='Image Expired';">
        </a>
        ${msg.caption ? `<div class="mt-1">${msg.caption}</div>` : ''}
      `;
    }

    // üìÑ DOCUMENT
    else if (msg.type === 'document') {
      const docUrl = msg.content;
      contentHtml = `
        <div class="d-flex align-items-center border p-2 rounded bg-light">
          <i class="bi bi-file-earmark-arrow-down fs-4 me-2"></i>
          <a href="${docUrl}" target="_blank" class="text-decoration-none">
            ${msg.filename || 'Download Document'}
          </a>
        </div>
        ${msg.caption ? `<div class="mt-1 small">${msg.caption}</div>` : ''}
      `;
    }

    // fallback
    else {
      contentHtml = `<div>[${msg.type}]</div>`;
    }

    div.innerHTML = `
      ${contentHtml}
      <div class="small text-muted mt-1" style="font-size: 0.7rem;">
        ${new Date(msg.timestamp).toLocaleString('en-IN', { 
            timeZone: 'UTC',
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit', 
            hour12: true 
        })}
      </div>
    `;

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  });
</script>

<script>
  function syncToNumber(form) {
    const selectedToEl = document.getElementById('toNumberSelect');
    if (!selectedToEl || !form) return;
    const selectedTo = selectedToEl.value;
    const hidden = form.querySelector('.hiddenToNumber');
    if (hidden) hidden.value = selectedTo;
  }
</script>

<script>
  function toggleEdit(field) {
    const displayDiv = document.getElementById(`display-${field}`);
    const formEl = document.getElementById(`form-${field}`);
    
    if (displayDiv.classList.contains('d-none')) {
      // Switch to Display Mode
      displayDiv.classList.remove('d-none');
      displayDiv.classList.add('d-flex');
      formEl.classList.add('d-none');
      formEl.classList.remove('d-flex');
    } else {
      // Switch to Edit Mode
      displayDiv.classList.add('d-none');
      displayDiv.classList.remove('d-flex');
      formEl.classList.remove('d-none');
      formEl.classList.add('d-flex');
    }
  }
</script>

<script>
  const deleteModal = document.getElementById('deleteRequirementModal');

  deleteModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;

    const leadId = button.getAttribute('data-lead-id');
    const reqId = button.getAttribute('data-req-id');
    const title = button.getAttribute('data-title');

    // Set modal text
    document.getElementById('deleteRequirementTitle').textContent = title;

    // Set form action dynamically
    const form = document.getElementById('deleteRequirementForm');
    form.action = `/leads/${leadId}/requirement/${reqId}/delete`;
  });
</script>

<script>
  function triggerFilePicker(type) {
    if (type === 'image') document.getElementById('imageInput').click();
    else if (type === 'document') document.getElementById('documentInput').click();
  }

  function handleFileSelect(input, type) {
    if (input.files && input.files[0]) {
      const file = input.files[0];
      const reader = new FileReader();
      
      // Show the wrapper
      document.getElementById('mediaPreviewWrapper').classList.remove('d-none');
      document.getElementById('mediaTypeInput').value = type;
      document.getElementById('textInput').placeholder = "Add a caption‚Ä¶";

      if (type === 'image') {
        reader.onload = function(e) {
            const img = document.getElementById('imagePreview');
            img.src = e.target.result;
            img.classList.remove('d-none');
            document.getElementById('docPreview').classList.add('d-none');
            document.getElementById('fileNameDisplay').innerText = file.name;
        };
        reader.readAsDataURL(file);
      } else {
        // For Documents
        document.getElementById('imagePreview').classList.add('d-none');
        const docPrev = document.getElementById('docPreview');
        docPrev.classList.remove('d-none');
        docPrev.classList.add('d-flex');
        document.getElementById('fileNameDisplay').innerText = file.name;
      }
      
      // Scroll chat to bottom so the new preview is visible
      const chatBox = document.querySelector('.chat-box');
      if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;
    }
  }

  function clearAttachment() {
    document.getElementById('imageInput').value = "";
    document.getElementById('documentInput').value = "";
    document.getElementById('mediaTypeInput').value = "text";
    
    document.getElementById('mediaPreviewWrapper').classList.add('d-none');
    document.getElementById('imagePreview').src = "#";
    document.getElementById('textInput').placeholder = "Type a message‚Ä¶";
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
