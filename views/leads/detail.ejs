<% function displaySource(source) { 
    const map = {
      google_sheet: 'Google Sheets',
      meta: 'Meta',
      indiamart: 'IndiaMART',
      manual: 'Manual Entry',
      excel_upload: 'Excel Upload'
    };
    return map[source] || source;
} %>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lead Detail - Olive Chairs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    .scroll-box, .status-box {
      min-height: 120px;
      max-height: 160px;  /* reduced from 280px */
      overflow-y: auto;
    }

    .chat-box {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
      min-height: 260px;
      max-height: 400px;
      overflow-y: auto;
      flex-grow: 1;
      margin-bottom: 0.5rem;
    }
    .chat-msg {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 75%;
      word-wrap: break-word;
    }
    .chat-msg.sent {
      background: #d1e7dd;
      margin-left: auto;
    }
    .chat-msg.received {
      background: #e2e3e5;
      margin-right: auto;
    }
  </style>
</head>
<body>
<%- include('../partials/navbar', { user, activePage }) %>
<div class="container py-4">
  
  <!-- Lead Info -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 fw-bold text-dark">
          <i class="bi bi-person-circle me-2 text-secondary"></i>
          <%= lead.customer_name %>
        </h4>
        <span class="badge bg-light text-dark border"><%= lead.status %></span>
      </div>

      <div class="row g-4">
        <!-- Contact Info -->
        <div class="col-md-6">
          <div class="mb-3">
            <small class="text-muted d-block">Phone</small>
            <div class="d-flex align-items-center">
              <span class="me-3"><%= lead.contact_number %></span>
              <% if (lead.contact_number) { %>
                <a href="tel:<%= lead.contact_number %>" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-telephone"></i> Call
                </a>
              <% } %>
            </div>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block">Email</small>
            <div class="d-flex align-items-center">
              <span class="me-3"><%= lead.email_id || '-' %></span>
              <% if (lead.email_id) { %>
                <a href="mailto:<%= lead.email_id %>" class="btn btn-sm btn-outline-secondary">
                  <i class="bi bi-envelope"></i> Draft
                </a>
              <% } %>
            </div>
          </div>

          <div class="mb-3">
            <small class="text-muted d-block">City</small>
            <span><%= lead.city || '—' %></span>
          </div>
        </div>

        <!-- Meta Info -->
        <div class="col-md-6">
          <div class="mb-3">
            <small class="text-muted d-block">Date</small>
            <span><%= lead.date ? new Date(lead.date).toLocaleDateString() : '-' %></span>
          </div>
          <div class="mb-3">
            <small class="text-muted d-block">Source</small>
            <span class="fw-semibold text-dark">
                <%= displaySource(lead.source) %>
                <% if (lead.sourceMeta && (lead.sourceMeta.byUser || lead.sourceMeta.importedAt || lead.sourceMeta.uploadedAt || lead.sourceMeta.createdAt)) { %>
                <small class="text-muted">
                    (
                    <% if (lead.sourceMeta.byUser) { %>
                    by <%= lead.sourceMeta.byUser %>
                    <% } %>
                    <% 
                    const sourceDate = lead.sourceMeta.importedAt || lead.sourceMeta.uploadedAt || lead.sourceMeta.createdAt;
                    if (sourceDate) { 
                    %>
                    on <%= new Date(sourceDate).toLocaleString() %>
                    <% } %>
                    )
                </small>
                <% } %>
            </span>
          </div>
          <div class="mb-3">
            <small class="text-muted d-block">Assigned To</small>
            <span><%= lead.assignedTo ? lead.assignedTo.fullName : '—' %></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Structured Requirement (new section) -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">Structured Requirement</h5>

      <% if (lead.normalizedRequirements && lead.normalizedRequirements.length) { %>
        <ul class="list-group mb-3">
          <% lead.normalizedRequirements.forEach(req => { %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <% 
                  const colorObj = req.chair && req.chair.colors.find(c => c._id.toString() === req.colorId.toString());
                  const basePrice = colorObj ? colorObj.basePrice : null;
                  const unitPrice = req.unitPrice;
                  const shipping = req.shippingUnit || 0;
                  const priceDiff = basePrice !== null 
                    ? ( (unitPrice / 1.18) - (basePrice / 1.18) - shipping ) 
                    : null;
                %>
                <strong><%= req.chair.modelName %></strong> – 
                <%= colorObj ? colorObj.name : 'Unknown Color' %>
                (x<%= req.quantity %>)
                <br>
                <small>Base Price: ₹<%= basePrice !== null ? basePrice : '-' %></small><br>
                <small>Shipping/Unit: ₹<%= shipping %></small><br>
                <small>
                  Unit: ₹<%= unitPrice %>
                  <% if (priceDiff !== null && priceDiff !== 0) { %>
                    <span class="<%= priceDiff > 0 ? 'text-danger' : 'text-success' %>">
                      (<%= priceDiff > 0 ? '+' : '' %><%= priceDiff %>)
                    </span>
                  <% } %>
                  | Total: ₹<%= req.totalPrice %>
                </small>
                <% if (req.note) { %>
                  <br><small class="text-muted">Note: <%= req.note %></small>
                <% } %>
              </div>
              <a href="/leads/<%= lead._id %>/requirement/<%= req._id %>/edit" class="btn btn-sm btn-outline-primary">Edit</a>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">No structured requirement set yet.</p>
      <% } %>
      <%
        let totalDiff = 0;
        (lead.normalizedRequirements || []).forEach(r => {
          const color = r.chair && r.chair.colors.find(c => c._id.toString() === r.colorId.toString());
          if (color) {
            const unitBase = (r.unitPrice || 0) / 1.18;
            const base = (color.basePrice || 0) / 1.18;
            const shipping = r.shippingUnit || 0;
            totalDiff += (unitBase - base - shipping) * r.quantity;
          }
        });
      %>
      <div class="alert 
        <%= totalDiff > 0 
            ? 'alert-danger' 
            : (totalDiff < 0 ? 'alert-success' : 'alert-secondary') %> 
        d-flex justify-content-between align-items-center mt-2">
        <span>
          Overall <%= totalDiff > 0 ? 'Markup' : (totalDiff < 0 ? 'Discount' : 'No markup/discount') %>
        </span>
        <strong>
          ₹<%= totalDiff %>
        </strong>
      </div>
      <a href="/leads/<%= lead._id %>/requirement/add" class="btn btn-sm btn-success">+ Add Requirement</a>
    </div>
  </div>

  <!-- Assign & Status -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Assign Lead</h6>
          <form action="/leads/<%= lead._id %>/assign" method="post" class="d-flex">
            <select name="userId" class="form-select me-2">
              <option value="">-- Assign User --</option>
              <% assignableUsers.forEach(u => { %>
                <option value="<%= u._id %>" <%= lead.assignedTo && lead.assignedTo._id.toString() === u._id.toString() ? 'selected' : '' %>>
                  <%= u.fullName %> (<%= u.role %>)
                </option>
              <% }) %>
            </select>
            <button class="btn btn-outline-primary">Assign</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Update Status</h6>
          <form action="/leads/<%= lead._id %>/status" method="post" class="d-flex align-items-center">
            <select name="status" id="statusSelect" class="form-select me-2" onchange="toggleCustomStatus()">
              <option value="">-- Update Status --</option>
              <% ["New","In Progress","Closed","Assigned"].forEach(s => { %>
                <option value="<%= s %>" <%= lead.status===s ? 'selected' : '' %>><%= s %></option>
              <% }) %>
              <option value="__other__">Other...</option>
            </select>
            <input type="text" name="customStatus" id="customStatusInput" class="form-control me-2 d-none" placeholder="Enter custom status">
            <button class="btn btn-outline-success">Update</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes + Status History (Left) | WhatsApp (Right) -->
  <div class="row">
    <div class="col-md-6">
      <!-- Notes -->
      <div class="card shadow-sm mb-2">
        <div class="card-body d-flex flex-column">
          <h5>Notes</h5>
          <form action="/leads/<%= lead._id %>/note" method="post" class="d-flex mb-3">
            <input type="text" name="note" class="form-control me-2" placeholder="Add a note..." required>
            <button class="btn btn-primary">Add</button>
          </form>
          <div class="scroll-box flex-grow-1">
            <% if (lead.notes.length) { %>
              <% lead.notes.slice().reverse().forEach(n => { %>
                <div class="border rounded p-2 mb-2 bg-light">
                  <%= n.text %>
                  <small class="text-muted d-block">
                    — <%= n.user ? n.user.fullName : 'Unknown' %>, 
                    <%= new Date(n.createdAt).toLocaleString() %>
                  </small>
                </div>
              <% }) %>
            <% } else { %>
              <p class="text-muted">No notes yet</p>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Status History -->
      <div class="card shadow-sm">
        <div class="card-body d-flex flex-column">
          <h5>Status History</h5>
          <div class="status-box flex-grow-1">
            <% if (lead.statusHistory.length) { %>
              <% lead.statusHistory.slice().reverse().forEach(h => { %>
                <div class="border rounded p-2 mb-2 bg-light">
                  <%= h.status %>
                  <small class="text-muted d-block">
                    — <%= h.changedBy ? h.changedBy.fullName : 'Unknown' %>, 
                    <%= new Date(h.createdAt).toLocaleString() %>
                  </small>
                </div>
              <% }) %>
            <% } else { %>
              <p class="text-muted">No status updates yet</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- WhatsApp -->
    <div class="col-md-6">
      <div class="card shadow-sm h-100 d-flex flex-column">
        <div class="card-body d-flex flex-column">
          <!-- Header with WhatsApp title + number selector -->
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">WhatsApp</h5>
            <form action="/leads/<%= lead._id %>/whatsapp-number" method="post" class="d-flex">
              <select name="whatsappNumberId" class="form-select form-select-sm me-2">
                <option value="">-- Select Number --</option>
                <% whatsappNumbers.forEach(num => { %>
                  <option value="<%= num.phone_number_id %>" <%= lead.whatsappNumberId === num.phone_number_id ? 'selected' : '' %>>
                    <%= num.display_number %> (<%= num.label %>)
                  </option>
                <% }) %>
              </select>
              <button class="btn btn-outline-success btn-sm">Save</button>
            </form>
          </div>
          <% if (!lead.whatsappNumberId) { %>
            <p class="text-muted">⚠️ Please assign a WhatsApp number to this lead before chatting.</p>
          <% } else { %>
            <div class="chat-box">
              <% if (chats.length) { %>
                <% chats.forEach(c => { %>
                  <div class="chat-msg <%= c.direction === 'outbound' ? 'sent' : 'received' %>">
                    <% if (c.type === 'text') { %>
                      <%= c.content %>
                    <% } else if (c.type === 'template') { %>
                      📑 Sent template: <strong><%= c.content %></strong>
                    <% } else if (c.type === 'image' && c.mediaId) { %>
                      <a href="/whatsapp/media/<%= c.mediaId %>" target="_blank">
                        <img src="/whatsapp/media/<%= c.mediaId %>" 
                            alt="Image" 
                            style="max-width:200px; border-radius:8px; display:block; margin-bottom:5px;">
                      </a>
                      <% if (c.caption) { %><div><%= c.caption %></div><% } %>
                    <% } else if (c.type === 'document' && c.mediaId) { %>
                      <a href="/whatsapp/media/<%= c.mediaId %>" target="_blank">
                        📄 Download Document
                      </a>
                      <% if (c.caption) { %><div><%= c.caption %></div><% } %>
                    <% } else if (c.type === 'audio' && c.mediaId) { %>
                      <audio controls style="width:100%;">
                        <source src="/whatsapp/media/<%= c.mediaId %>" type="audio/mpeg">
                        Your browser does not support the audio element.
                      </audio>
                    <% } else { %>
                      [<%= c.type %>]
                    <% } %>
                    <div class="small text-muted">
                      <%= new Date(c.timestamp).toLocaleString() %>
                    </div>
                  </div>
                <% }) %>
              <% } else { %>
                <p class="text-muted">No messages yet</p>
              <% } %>
            </div>

            <!-- Chat input -->
            <% if (canFreeChat) { %>
              <!-- ✅ Normal text input (within 24h after reply) -->
              <form action="/leads/<%= lead._id %>/whatsapp/send-text" method="post" class="d-flex mt-2">
                <input type="hidden" name="to" value="<%= lead.contact_number %>">
                <input type="text" name="body" class="form-control me-2" placeholder="Type a message..." required>
                <button class="btn btn-success"><i class="bi bi-send"></i></button>
              </form>
            <% } else { %>
              <!-- ⚠️ Session expired or no reply yet → template required -->
              <form action="/leads/<%= lead._id %>/whatsapp/send-text" method="post" class="d-flex mt-2">
                <input type="hidden" name="to" value="<%= lead.contact_number %>">
                <select name="templateName" class="form-select me-2" required>
                  <option value="">-- Select Template --</option>
                  <% whatsappTemplates.forEach(t => { %>
                    <option value="<%= t.name %>||<%= t.language %>"><%= t.name %> (<%= t.language %>)</option>
                  <% }) %>
                </select>
                <button class="btn btn-primary">
                  <i class="bi bi-chat-left-text"></i>
                </button>
              </form>
              <p class="text-muted small mt-1">
                💡 A template message must be sent first. Once the user replies, you can chat freely for 24h.
              </p>
            <% } %>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleCustomStatus() {
    const select = document.getElementById('statusSelect');
    const input = document.getElementById('customStatusInput');
    if (select.value === '__other__') {
      input.classList.remove('d-none');
      input.required = true;
    } else {
      input.classList.add('d-none');
      input.required = false;
    }
  }
</script>

<script>
  function scrollChatToBottom() {
    const chatBox = document.querySelector('.chat-box');
    chatBox.scrollTop = chatBox.scrollHeight;
  }
  // Auto-scroll on load
  window.addEventListener('DOMContentLoaded', scrollChatToBottom);
  // Optional: re-scroll on new message add (you’ll hook this after adding msgs via JS/Server)
</script>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  // join this lead’s room
  socket.emit('joinLeadRoom', "<%= lead._id %>");

  // when server pushes a new message
  socket.on('newMessage', (msg) => {
    console.log("📩 New message arrived", msg);

    const chatBox = document.querySelector('.chat-box');

    // create message bubble
    const div = document.createElement('div');
    div.className = 'chat-msg ' + (msg.direction === 'outbound' ? 'sent' : 'received');
    div.innerHTML = `
      ${msg.type === 'text' ? msg.content : `[${msg.type}]`}
      <div class="small text-muted">${new Date(msg.timestamp).toLocaleString()}</div>
    `;

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
