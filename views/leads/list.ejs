<% function displaySource(source) { 
    const map = {
      google_sheet: 'Google Sheets',
      meta: 'Meta',
      indiamart: 'IndiaMART',
      manual: 'Manual Entry',
      excel_upload: 'Excel Upload'
    };
    return map[source] || source;
} %>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leads - Olive Chairs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    .sticky-actions {
      position: sticky;
      top: 0;
      z-index: 1020;
      background: #fff;
      padding: .5rem 0;
    }
    .row-select-col {
      width: 36px;
    }
  </style>
</head>
<body>
<%- include('../partials/navbar', { user, activePage }) %>

<div class="container py-5">

  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
    <h3 class="mb-2 mb-md-0">Leads</h3>

    <div class="d-flex flex-wrap justify-content-start justify-content-md-end gap-2 w-100 w-md-auto">
      <a href="/leads/create" class="btn btn-outline-primary flex-fill flex-md-grow-0">Add Lead</a>
      <% if (user && user.role === 'admin') { %>
        <a href="/leads/import/google" class="btn btn-outline-success flex-fill flex-md-grow-0">Import Google Sheet</a>
        <button type="button" class="btn btn-outline-warning flex-fill flex-md-grow-0" data-bs-toggle="modal" data-bs-target="#uploadExcelModal">
          Upload from Excel
        </button>
      <% } %>
    </div>
  </div>

  <!-- Filters -->
  <form class="row g-2 mb-3" method="get" action="/leads">
    <div class="col-12 col-sm-12 col-md-3">
      <input name="search" class="form-control" placeholder="Search" value="<%= query.search||'' %>">
    </div>
    <div class="col-6 col-sm-6 col-md-2">
      <select name="status" class="form-select">
        <option value="">All Status</option>
        <option value="New" <%= query.status==='New' ? 'selected' : '' %>>New</option>
        <option value="In Progress" <%= query.status==='In Progress' ? 'selected' : '' %>>In Progress</option>
        <option value="Closed" <%= query.status==='Closed' ? 'selected' : '' %>>Closed</option>
        <option value="Assigned" <%= query.status==='Assigned' ? 'selected' : '' %>>Assigned</option>
        <option value="Deal Drop" <%= query.status==='Deal Drop' ? 'selected' : '' %>>Deal Drop</option>
      </select>
    </div>
    <div class="col-6 col-sm-6 col-md-2">
      <select name="source" class="form-select">
        <option value="">All Source</option>
        <option value="google_sheet" <%= query.source==='google_sheet' ? 'selected' : '' %>>Google Sheets</option>
        <option value="meta" <%= query.source==='meta' ? 'selected' : '' %>>Meta</option>
        <option value="indiamart" <%= query.source==='indiamart' ? 'selected' : '' %>>IndiaMART</option>
        <option value="manual" <%= query.source==='manual' ? 'selected' : '' %>>Manual</option>
        <option value="excel_upload" <%= query.source==='excel_upload' ? 'selected' : '' %>>Excel</option>
      </select>
    </div>
    <div class="col-6 col-sm-6 col-md-2">
      <select name="sortField" class="form-select">
        <option value="createdAt" <%= query.sortField==='createdAt' ? 'selected' : '' %>>Newest</option>
        <option value="customer_name" <%= query.sortField==='customer_name' ? 'selected' : '' %>>Name</option>
      </select>
    </div>
    <div class="col-6 col-sm-6 col-md-1">
      <select name="sortOrder" class="form-select">
        <option value="desc" <%= query.sortOrder==='desc' ? 'selected' : '' %>>Desc</option>
        <option value="asc" <%= query.sortOrder==='asc' ? 'selected' : '' %>>Asc</option>
      </select>
    </div>
    <div class="col-12 col-sm-12 col-md-2 d-grid">
      <button class="btn btn-primary">Filter</button>
    </div>
  </form>

  <% if (user && user.role === 'admin') { %>
  <!-- Sticky bulk actions (admins only) -->
  <div class="sticky-actions d-flex align-items-center justify-content-between mb-2">
    <div class="small text-muted">
      Selected: <span id="selectedCount">0</span>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-success btn-sm" id="openBulkAssignBtn" data-bs-toggle="modal" data-bs-target="#bulkAssignModal" disabled>
        Assign Selected
      </button>
    </div>
  </div>
  <% } %>

  <!-- Leads Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <% if (leads && leads.length) { %>
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle">
            <thead class="table-light">
              <tr>
                <% if (user && user.role === 'admin') { %>
                  <th class="row-select-col">
                    <input class="form-check-input" type="checkbox" id="selectAll">
                  </th>
                <% } %>
                <th style="width: 40px;">#</th>
                <th style="width: 100px;">Date</th>
                <th style="max-width: 120px;">Name</th>
                <th style="max-width: 120px;">Contact</th>
                <th style="max-width: 180px;">Email</th>
                <th style="max-width: 100px;">City</th>
                <th style="max-width: 150px;">Requirement</th>
                <th style="width: 120px;">Source</th>
                <th class="text-nowrap" style="max-width: 150px;">Lead Source</th>
                <th style="width: 110px;">Status</th>
                <th style="max-width: 160px;">Assigned</th>
                <th style="width: 160px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% leads.forEach((l,i) => { %>
                <tr>
                  <% if (user && user.role === 'admin') { %>
                    <td>
                      <input class="form-check-input lead-checkbox" type="checkbox" value="<%= l._id %>">
                    </td>
                  <% } %>
                  <td><%= (page-1)*limit + i + 1 %></td>
                  <td class="text-nowrap"><%= l.date ? new Date(l.date).toLocaleDateString() : '-' %></td>
                  <td class="text-truncate" style="max-width:120px;" title="<%= l.customer_name %>"><%= l.customer_name %></td>
                  <td class="text-truncate" style="max-width:120px;" title="<%= l.contact_number %>"><%= l.contact_number %></td>
                  <td class="text-truncate" style="max-width:180px;" title="<%= l.email_id %>"><%= l.email_id %></td>
                  <td class="text-truncate" style="max-width:100px;" title="<%= l.city %>"><%= l.city || '-' %></td>
                  <td class="text-truncate" style="max-width:150px;" title="<%= l.requirement %>"><%= l.requirement %></td>
                  <td><%= displaySource(l.source) %></td>
                  <td class="text-truncate" style="max-width:150px;" title="<%= l.leadSource %>"><%= l.leadSource || '-' %></td>
                  <td>
                    <span class="badge 
                      <%= l.status==='New' ? 'bg-primary' : 
                          l.status==='In Progress' ? 'bg-warning' :
                          l.status==='Assigned' ? 'bg-info' :
                          l.status==='Deal Drop' ? 'bg-danger' :
                          l.status==='Closed' ? 'bg-success' :
                          'bg-secondary' %>">
                      <%= l.status %>
                    </span>
                  </td>
                  <td class="text-truncate" style="max-width:160px;" title="<%= l.assignedTo ? (l.assignedTo.fullName || l.assignedTo.username) : '-' %>">
                    <%= l.assignedTo ? (l.assignedTo.fullName || l.assignedTo.username) : '-' %>
                  </td>
                  <td class="text-end">
                    <div class="d-flex gap-1 flex-nowrap justify-content-end">
                      <a href="/leads/<%= l._id %>" class="btn btn-sm btn-outline-primary">View</a>
                      <% if (user && user.role === 'admin') { %>
                        <button type="button" 
                                class="btn btn-sm btn-outline-success" 
                                data-bs-toggle="modal" 
                                data-bs-target="#assignModal" 
                                data-lead-id="<%= l._id %>">
                          Assign
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-outline-danger" 
                                data-bs-toggle="modal" 
                                data-bs-target="#deleteModal" 
                                data-lead-id="<%= l._id %>"
                                data-lead-name="<%= l.customer_name %>">
                          Delete
                        </button>
                      <% } %>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="pagination">
          <ul class="pagination justify-content-center">
            <li class="page-item <%= page === 1 ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= page-1 %>" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            <% for(let p=1; p<=totalPages; p++){ %>
              <li class="page-item <%= p===page ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= p %>"><%= p %></a>
              </li>
            <% } %>
            <li class="page-item <%= page === totalPages ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= page+1 %>" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          </ul>
        </nav>

      <% } else { %>
        <p class="text-muted">No leads found.</p>
      <% } %>
    </div>
  </div>
</div>

<!-- Single Assign Modal (existing per-row) -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="assignForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Assign Lead</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Assign this lead to:</p>
          <input type="hidden" name="leadId" id="assignLeadId">
          <div class="mb-3">
            <select class="form-select" id="userId" name="userId" required>
              <option value="">-- Select User --</option>
              <% if (users) { users.forEach(u => { %>
                <option value="<%= u._id %>"><%= u.fullName %> (<%= u.role %>)</option>
              <% }) } %>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Assign</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk Assign Modal (NEW) -->
<div class="modal fade" id="bulkAssignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="bulkAssignForm" method="POST" action="/leads/bulk-assign">
        <div class="modal-header">
          <h5 class="modal-title">Assign Selected Leads</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">Assign <strong id="bulkCount">0</strong> selected lead(s) to:</p>
          <div class="mb-3">
            <select class="form-select" id="bulkUserId" name="userId" required>
              <option value="">-- Select User --</option>
              <% if (users) { users.forEach(u => { %>
                <option value="<%= u._id %>"><%= u.fullName %> (<%= u.role %>)</option>
              <% }) } %>
            </select>
          </div>
          <!-- leadIds[] are injected here dynamically -->
          <div id="bulkHiddenInputs"></div>
          <small class="text-muted">Status will be set to <strong>Assigned</strong> for all selected leads.</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Assign</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Upload Excel Modal -->
<div class="modal fade" id="uploadExcelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="/leads/import/excel" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Upload Leads from Excel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Choose Excel File (.xlsx or .xls)</label>
            <input type="file" name="excelFile" class="form-control" accept=".xlsx,.xls" required>
          </div>
          <small class="text-muted">
            Please use the 
            <a href="/leads/sample-excel" target="_blank">sample Excel template</a>.
          </small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="deleteForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Delete Lead</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this lead?</p>
          <input type="hidden" name="leadId" id="deleteLeadId">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Single assign modal (existing)
  const assignModal = document.getElementById('assignModal');
  assignModal?.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const leadId = button.getAttribute('data-lead-id');
    document.getElementById('assignLeadId').value = leadId;
    document.getElementById('assignForm').action = `/leads/${leadId}/assign`;
  });

  // Delete modal (existing)
  const deleteModal = document.getElementById('deleteModal');
  deleteModal?.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const leadId = button.getAttribute('data-lead-id');
    const leadName = button.getAttribute('data-lead-name');
    document.getElementById('deleteLeadId').value = leadId;
    document.getElementById('deleteForm').action = `/leads/${leadId}/delete`;
    const modalBody = deleteModal.querySelector('.modal-body p');
    modalBody.innerHTML = `Are you sure you want to delete lead <strong>"${leadName}"</strong>?`;
  });

  // ===== Bulk selection logic (admin only) =====
  const selectAll = document.getElementById('selectAll');
  const checkboxes = document.querySelectorAll('.lead-checkbox');
  const selectedCountEl = document.getElementById('selectedCount');
  const openBulkAssignBtn = document.getElementById('openBulkAssignBtn');
  const bulkAssignModal = document.getElementById('bulkAssignModal');
  const bulkHiddenInputs = document.getElementById('bulkHiddenInputs');
  const bulkCount = document.getElementById('bulkCount');

  function updateSelectedState() {
    const selected = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
    selectedCountEl && (selectedCountEl.textContent = selected.length);
    if (openBulkAssignBtn) openBulkAssignBtn.disabled = selected.length === 0;
    return selected;
  }

  selectAll?.addEventListener('change', () => {
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateSelectedState();
  });

  checkboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      if (!cb.checked && selectAll) selectAll.checked = false;
      updateSelectedState();
    });
  });

  // Inject selected IDs into the bulk form when modal opens
  bulkAssignModal?.addEventListener('show.bs.modal', () => {
    const ids = updateSelectedState();
    bulkCount.textContent = ids.length;
    bulkHiddenInputs.innerHTML = '';
    ids.forEach(id => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'leadIds[]';
      input.value = id;
      bulkHiddenInputs.appendChild(input);
    });
  });


  document.getElementById("bulkAssignForm")?.addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;
    const userId = document.getElementById("bulkUserId").value;
    const leadIds = Array.from(form.querySelectorAll("input[name='leadIds[]']")).map(i => i.value);

    try {
      const res = await fetch("/leads/bulk-assign", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, leadIds })
      });

      const data = await res.json();
      if (!res.ok || !data.success) throw new Error(data.error || "Bulk assign failed");

      // Build toast dynamically
      const toastHtml = `
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div class="toast border rounded shadow-sm" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">
                <strong>Bulk Assign Completed.</strong><br>
                ${data.assigned} lead(s) assigned successfully.
                ${data.skipped > 0 ? `<br>${data.skipped} skipped (already assigned, closed, or deal drop).` : ""}
              </div>
              <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML("beforeend", toastHtml);

      // Show toast
      const toastEl = document.querySelector(".toast:last-child");
      const toast = new bootstrap.Toast(toastEl, { delay: 6000 });
      toast.show();

      // Close modal + reset form
      const modalEl = document.getElementById("bulkAssignModal");
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
      form.reset();

      // ✅ Update UI inline (only for assigned leads)
      data.assignedIds.forEach(id => {
        const row = document.querySelector(`input[value="${id}"]`)?.closest("tr");
        if (row) {
          const statusBadge = row.querySelector("td:nth-child(10) .badge");
          if (statusBadge) {
            statusBadge.textContent = "Assigned";
            statusBadge.className = "badge bg-info";
          }

          const assignedCell = row.querySelector("td:nth-child(11)");
          if (assignedCell) {
            assignedCell.textContent = data.user;
          }

          const checkbox = row.querySelector(".lead-checkbox");
          if (checkbox) checkbox.checked = false;
        }
      });

      // ✅ Just uncheck skipped leads, don't overwrite
      data.skippedIds.forEach(id => {
        const checkbox = document.querySelector(`input[value="${id}"]`);
        if (checkbox) checkbox.checked = false;
      });

      // reset bulk select UI
      updateSelectedState();

    } catch (err) {
      console.error("Bulk assign error:", err);
      alert("Failed to assign leads. Please try again.");
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
