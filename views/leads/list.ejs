<% function displaySource(source) { 
    const map = {
    google_sheet: 'Google Sheets',
    meta: 'Meta',
    indiamart: 'IndiaMART',
    manual: 'Manual Entry',
    excel_upload: 'Excel Upload'
    };
    return map[source] || source;
} %>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leads - Olive Chairs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
<%- include('../partials/navbar', { user, activePage }) %>
<div class="container py-5">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
    <h3 class="mb-2 mb-md-0">Leads</h3>
    <div class="d-flex flex-wrap justify-content-start justify-content-md-end gap-2 w-100 w-md-auto">
      <a href="/leads/create" class="btn btn-outline-primary flex-fill flex-md-grow-0">Add Lead</a>
      <% if (user && user.role === 'admin') { %>
        <a href="/leads/import/google" class="btn btn-outline-success flex-fill flex-md-grow-0">Import Google Sheet</a>
        <button type="button" class="btn btn-outline-warning flex-fill flex-md-grow-0" data-bs-toggle="modal" data-bs-target="#uploadExcelModal">
            Upload from Excel
        </button>
      <% } %>
    </div>
  </div>

  <!-- Filters -->
  <form class="row g-2 mb-3" method="get" action="/leads">
    <div class="col-12 col-sm-12 col-md-3">
        <input name="search" class="form-control" placeholder="Search" value="<%= query.search||'' %>">
    </div>
    <div class="col-6 col-sm-6 col-md-2">
        <select name="status" class="form-select">
        <option value="">All Status</option>
        <option value="New" <%= query.status==='New' ? 'selected' : '' %>>New</option>
        <option value="In Progress" <%= query.status==='In Progress' ? 'selected' : '' %>>In Progress</option>
        <option value="Closed" <%= query.status==='Closed' ? 'selected' : '' %>>Closed</option>
        <option value="Assigned" <%= query.status==='Assigned' ? 'selected' : '' %>>Assigned</option>
        </select>
    </div>
    <div class="col-6 col-sm-6 col-md-2">
        <select name="source" class="form-select">
        <option value="">All Source</option>
        <option value="google_sheet" <%= query.source==='google_sheet' ? 'selected' : '' %>>Google Sheets</option>
        <option value="meta" <%= query.source==='meta' ? 'selected' : '' %>>Meta</option>
        <option value="indiamart" <%= query.source==='indiamart' ? 'selected' : '' %>>IndiaMART</option>
        <option value="manual" <%= query.source==='manual' ? 'selected' : '' %>>Manual</option>
        <option value="excel_upload" <%= query.source==='excel_upload' ? 'selected' : '' %>>Excel</option>
        </select>
    </div>
    <div class="col-6 col-sm-6 col-md-2">
        <select name="sortField" class="form-select">
        <option value="createdAt" <%= query.sortField==='createdAt' ? 'selected' : '' %>>Newest</option>
        <option value="customer_name" <%= query.sortField==='customer_name' ? 'selected' : '' %>>Name</option>
        </select>
    </div>
    <div class="col-6 col-sm-6 col-md-1">
        <select name="sortOrder" class="form-select">
        <option value="desc" <%= query.sortOrder==='desc' ? 'selected' : '' %>>Desc</option>
        <option value="asc" <%= query.sortOrder==='asc' ? 'selected' : '' %>>Asc</option>
        </select>
    </div>
    <div class="col-12 col-sm-12 col-md-2 d-grid">
        <button class="btn btn-primary">Filter</button>
    </div>
    </form>

  <!-- Leads Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <% if (leads && leads.length) { %>
        <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th style="width: 40px;">#</th>
                <th style="width: 100px;">Date</th>
                <th style="max-width: 120px;">Name</th>
                <th style="max-width: 120px;">Contact</th>
                <th style="max-width: 180px;">Email</th>
                <th style="max-width: 100px;">City</th>
                <th style="max-width: 150px;">Requirement</th>
                <th style="width: 120px;">Source</th>
                <th style="width: 100px;">Status</th>
                <th style="max-width: 140px;">Assigned</th>
                <th style="width: 120px;">Actions</th>
            </tr>
            </thead>
            <tbody>
            <% leads.forEach((l,i) => { %>
                <tr>
                <td><%= (page-1)*limit + i + 1 %></td>
                <td class="text-nowrap"><%= l.date ? new Date(l.date).toLocaleDateString() : '-' %></td>
                <td class="text-truncate" style="max-width:120px;" title="<%= l.customer_name %>"><%= l.customer_name %></td>
                <td class="text-truncate" style="max-width:120px;" title="<%= l.contact_number %>"><%= l.contact_number %></td>
                <td class="text-truncate" style="max-width:180px;" title="<%= l.email_id %>"><%= l.email_id %></td>
                <td class="text-truncate" style="max-width:100px;" title="<%= l.city %>"><%= l.city || '-' %></td>
                <td class="text-truncate" style="max-width:150px;" title="<%= l.requirement %>"><%= l.requirement %></td>
                <td><%= displaySource(l.source) %></td>
                <td>
                    <span class="badge 
                    <%= l.status==='New' ? 'bg-primary' : 
                        l.status==='In Progress' ? 'bg-warning text-dark' :
                        l.status==='Assigned' ? 'bg-info text-dark' :
                        'bg-success' %>">
                    <%= l.status %>
                    </span>
                </td>
                <td class="text-truncate" style="max-width:140px;" title="<%= l.assignedTo ? l.assignedTo.fullName : '-' %>">
                    <%= l.assignedTo ? l.assignedTo.fullName : '-' %>
                </td>
                <td class="text-end">
                <div class="d-flex gap-1 flex-nowrap justify-content-end">
                    <a href="/leads/<%= l._id %>" class="btn btn-sm btn-outline-primary">View</a>
                    <% if (user && user.role === 'admin') { %>
                    <button type="button" 
                            class="btn btn-sm btn-outline-success" 
                            data-bs-toggle="modal" 
                            data-bs-target="#assignModal" 
                            data-lead-id="<%= l._id %>">
                        Assign
                    </button>
                    <% } %>
                </div>
                </td>
                </tr>
            <% }) %>
            </tbody>
        </table>
        </div>


        <!-- Pagination -->
        <nav aria-label="pagination">
        <ul class="pagination justify-content-center">
            <!-- Previous -->
            <li class="page-item <%= page === 1 ? 'disabled' : '' %>">
            <a class="page-link" href="?page=<%= page-1 %>" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
            </li>

            <!-- Page numbers -->
            <% for(let p=1; p<=totalPages; p++){ %>
            <li class="page-item <%= p===page ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= p %>"><%= p %></a>
            </li>
            <% } %>

            <!-- Next -->
            <li class="page-item <%= page === totalPages ? 'disabled' : '' %>">
            <a class="page-link" href="?page=<%= page+1 %>" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
            </li>
        </ul>
        </nav>

      <% } else { %>
        <p class="text-muted">No leads found.</p>
      <% } %>
    </div>
  </div>
</div>

<!-- Assign Modal -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="assignForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Assign Lead</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Assign this lead to:</p>
          <input type="hidden" name="leadId" id="assignLeadId">
          <div class="mb-3">
            <select class="form-select" id="userId" name="userId" required>
              <option value="">-- Select User --</option>
              <% users.forEach(u => { %>
                <option value="<%= u._id %>"><%= u.fullName %> (<%= u.role %>)</option>
              <% }) %>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Assign</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Upload Excel Modal -->
<div class="modal fade" id="uploadExcelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="/leads/import/excel" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Upload Leads from Excel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Choose Excel File (.xlsx or .xls)</label>
            <input type="file" name="excelFile" class="form-control" accept=".xlsx,.xls" required>
          </div>
          <small class="text-muted">
            Please use the 
            <a href="/leads/sample-excel" target="_blank">sample Excel template</a>.
          </small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const assignModal = document.getElementById('assignModal');
  assignModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const leadId = button.getAttribute('data-lead-id');
    document.getElementById('assignLeadId').value = leadId;
    document.getElementById('assignForm').action = `/leads/${leadId}/assign`;
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
