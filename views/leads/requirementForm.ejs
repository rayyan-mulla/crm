<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= mode === 'add' ? 'Add Requirements' : 'Edit Requirement' %> - Olive Chairs CRM</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .req-row { 
      background: #f8f9fa; 
      border-radius: 8px; 
      padding: 15px; 
    }
  </style>
</head>
<body>
<%- include('../partials/navbar', { user, activePage }) %>

<div class="container py-4">
  <h3 class="mb-3">
    <%= mode === 'add' ? 'Add Requirements' : 'Edit Requirement' %> for <%= lead.customer_name %>
  </h3>

  <form action="<%= mode === 'add' 
      ? `/leads/${lead._id}/requirement/add` 
      : `/leads/${lead._id}/requirement/${requirement._id}/edit` %>" 
    method="post" class="card shadow-sm p-4">

    <div id="requirementsContainer" class="vstack gap-3">
      
      <% if (mode === 'edit') { %>
        <!-- Single row for edit -->
        <div class="req-row">
          <div class="mb-3">
            <label class="form-label">Chair Model</label>
            <select name="chairId" class="form-select chairSelect" required>
              <% chairs.forEach(c => { %>
                <option value="<%= c._id %>" <%= requirement.chair._id.toString() === c._id.toString() ? 'selected' : '' %>>
                  <%= c.modelName %>
                </option>
              <% }) %>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Color</label>
            <select name="colorId" class="form-select colorSelect" data-selected-color="<%= requirement.colorId.toString() %>" required>
              <option value="">-- Select Color --</option>
            </select>
          </div>

          <div class="mb-3 row">
            <div class="col-md-3">
              <label class="form-label">Quantity</label>
              <input type="number" name="quantity" class="form-control qty" min="1" value="<%= requirement.quantity %>" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Unit Price (₹)</label>
              <div class="input-group">
                <input type="number" name="unitPrice" class="form-control unit" min="0" step="1" value="<%= requirement.unitPrice %>" required>
                <div class="input-group-text">
                  <input class="form-check-input mt-0 gstCheck" type="checkbox" name="gstApplicable" value="true" <%= requirement.gstApplicable ? 'checked' : '' %>>
                  <small class="ms-1">GST</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Shipping/Unit (₹)</label>
              <input type="number" name="shippingUnit" class="form-control ship" min="0" step="1" value="<%= requirement.shippingUnit || 0 %>" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Total Price (₹)</label>
              <input type="text" class="form-control total" value="<%= requirement.totalPrice %>" readonly>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Note</label>
            <textarea name="note" class="form-control" rows="2"><%= requirement.note %></textarea>
          </div>
        </div>
      <% } else { %>
        <!-- First empty row in add mode -->
        <div class="req-row">
          <div class="mb-3">
            <label class="form-label">Chair Model</label>
            <select name="requirements[0][chairId]" class="form-select chairSelect" required>
              <option value="">-- Select Model --</option>
              <% chairs.forEach(c => { %>
                <option value="<%= c._id %>"><%= c.modelName %></option>
              <% }) %>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Color</label>
            <select name="requirements[0][colorId]" class="form-select colorSelect" required>
              <option value="">-- Select Color --</option>
            </select>
          </div>

          <div class="mb-3 row">
            <div class="col-md-3">
              <label class="form-label">Quantity</label>
              <input type="number" name="requirements[0][quantity]" class="form-control qty" min="1" value="1" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Unit Price (₹)</label>
              <div class="input-group">
                <input type="number" name="requirements[0][unitPrice]" class="form-control unit" min="0" step="1" required>
                <div class="input-group-text">
                  <input class="form-check-input mt-0 gstCheck" type="checkbox" name="requirements[0][gstApplicable]" value="true">
                  <small class="ms-1">GST</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Shipping/Unit (₹)</label>
              <input type="number" name="requirements[0][shippingUnit]" class="form-control ship" min="0" step="1" value="0" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Total Price (₹)</label>
              <input type="text" class="form-control total" readonly>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Note</label>
            <textarea name="requirements[0][note]" class="form-control" rows="2"></textarea>
          </div>
        </div>
      <% } %>
    </div>

    <!-- Add more requirements button -->
    <% if (mode === 'add') { %>
      <button type="button" id="addRequirement" class="btn btn-outline-primary my-3">+ Add More Requirement</button>
    <% } %>

    <div class="d-flex justify-content-end mt-3">
      <a href="/leads/<%= lead._id %>" class="btn btn-secondary me-2">Cancel</a>
      <button class="btn btn-<%= mode === 'add' ? 'success' : 'primary' %>">
        <%= mode === 'add' ? 'Add Requirements' : 'Save Changes' %>
      </button>
    </div>
  </form>
</div>

<script>
  const chairs = <%- JSON.stringify(chairs) %>;
  const container = document.getElementById('requirementsContainer');
  const addBtn = document.getElementById('addRequirement');

  // counter for rows
  let index = 1;

  // Add new requirement row dynamically
  addBtn?.addEventListener('click', () => {
    const row = document.createElement('div');
    row.className = 'req-row';
    row.innerHTML = `
      <div class="mb-3">
        <label class="form-label">Chair Model</label>
        <select name="requirements[${index}][chairId]" class="form-select chairSelect" required>
          <option value="">-- Select Model --</option>
          ${chairs.map(c => `<option value="${c._id}">${c.modelName}</option>`).join('')}
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Color</label>
        <select name="requirements[${index}][colorId]" class="form-select colorSelect" required>
          <option value="">-- Select Color --</option>
        </select>
      </div>
      <div class="mb-3 row">
        <div class="col-md-3">
          <label class="form-label">Quantity</label>
          <input type="number" name="requirements[${index}][quantity]" class="form-control qty" min="1" value="1" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Unit Price (₹)</label>
          <div class="input-group">
            <input type="number" name="requirements[${index}][unitPrice]" class="form-control unit" min="0" step="1" required>
            <div class="input-group-text">
              <input class="form-check-input mt-0 gstCheck" type="checkbox" name="requirements[${index}][gstApplicable]" value="true">
              <small class="ms-1">GST</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Shipping/Unit (₹)</label>
          <input type="number" name="requirements[${index}][shippingUnit]" class="form-control ship" min="0" step="1" value="0" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Total Price (₹)</label>
          <input type="text" class="form-control total" readonly>
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Note</label>
        <textarea name="requirements[${index}][note]" class="form-control" rows="2"></textarea>
      </div>
      <div class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger removeReq">✕ Remove</button>
      </div>
    `;
    container.appendChild(row);
    index++;
  });

  // Remove requirement row
  container.addEventListener('click', e => {
    if (e.target.classList.contains('removeReq')) {
      e.target.closest('.req-row')?.remove();
    }
  });

  // Populate colors when chair changes
  container.addEventListener('change', e => {
    if (!e.target.classList.contains('chairSelect')) return;

    const row = e.target.closest('.req-row');
    const chairId = e.target.value;
    const colorSelect = row.querySelector('.colorSelect');
    const selectedColor = colorSelect.dataset.selectedColor;

    colorSelect.innerHTML = '<option value="">-- Select Color --</option>';

    const chair = chairs.find(c => String(c._id) === String(chairId));
    if (!chair || !chair.colors) return;

    chair.colors.forEach(col => {
      const base = col.basePrice || 0;
      const hasGst = col.gstApplicable === true;
      const final = hasGst ? Math.round(base * 1.18) : base;

      const opt = document.createElement('option');
      opt.value = col._id;
      opt.textContent = hasGst
        ? `${col.name} — ₹${base} + 18% GST = ₹${final}`
        : `${col.name} — ₹${base} (No GST)`;

      if (selectedColor && String(selectedColor) === String(col._id)) {
        opt.selected = true;
      }

      colorSelect.appendChild(opt);
    });
  });

  // Auto calculate total (qty * (unit + ship))
  function calculateRow(row) {
    const q = parseInt(row.querySelector('.qty').value) || 0;
    const u = parseFloat(row.querySelector('.unit').value) || 0;
    const s = parseFloat(row.querySelector('.ship').value) || 0;
    const isGst = row.querySelector('.gstCheck').checked;

    // Formula: ((Unit * 1.18 if GST) + Shipping) * Quantity
    const unitWithGst = isGst ? (u * 1.18) : u;
    
    // Note: Added '+ s' back here so shipping is actually included in the total
    const total = Math.round((unitWithGst + s) * q);

    row.querySelector('.total').value = total;
  }

  // 2. Listen for typing (numbers/text)
  container.addEventListener('input', e => {
    const row = e.target.closest('.req-row');
    if (row) calculateRow(row);
  });

  // 3. Listen for toggles (checkboxes/select dropdowns)
  container.addEventListener('change', e => {
    const row = e.target.closest('.req-row');
    if (row) calculateRow(row);
  });

  // 4. Auto-trigger chair change on page load (EDIT MODE)
  // This ensures colors are populated and the previously selected color
  // is restored when editing an existing requirement.
  // Note: `bubbles: true` is required because the change listener
  // is attached to the container using event delegation.
  document.querySelectorAll('.chairSelect').forEach(select => {
    if (select.value) {
      select.dispatchEvent(new Event('change', { bubbles: true }));
    }
  });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
