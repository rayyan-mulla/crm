<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= mode === 'create' ? 'Add Chair Model' : 'Edit Chair Model' %> - Olive Chairs CRM</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    .color-row { background: #f8f9fa; border-radius: 8px; padding: 10px; }
  </style>
</head>
<body>
<%- include('../partials/navbar', { user, activePage }) %>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3><%= mode === 'create' ? 'Add Chair Model' : 'Edit Chair Model' %></h3>
    <!-- <a href="/chairs" class="btn btn-secondary">Back</a> -->
  </div>

  <form action="<%= mode === 'create' ? '/chairs' : '/chairs/' + chair._id %>" method="post" class="card shadow-sm">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Model Name</label>
          <input name="modelName" class="form-control" required value="<%= chair.modelName || '' %>"/>
        </div>
        <div class="col-md-6 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="isActive" id="isActive"
              <%= (mode==='create' ? 'checked' : (chair.isActive ? 'checked' : '')) %> />
            <label class="form-check-label" for="isActive">Active</label>
          </div>
        </div>
      </div>

      <hr class="my-4"/>

      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Colors & Base Prices</h5>
        <button type="button" id="addColor" class="btn btn-sm btn-outline-primary">Add Color</button>
      </div>

      <div id="colorsContainer" class="vstack gap-2">
        <% (chair.colors || []).forEach(function(col){ %>
          <div class="color-row row g-2 align-items-center">
            <input type="hidden" name="colorId" value="<%= col._id %>"/>
            <div class="col-md-5">
              <input class="form-control" name="colorName" placeholder="Color name" required value="<%= col.name %>"/>
            </div>
            <div class="col-md-4">
              <input class="form-control" name="colorPrice" type="number" step="1" min="0" placeholder="Base price" required value="<%= col.basePrice %>"/>
            </div>
            <div class="col-md-2 form-check ps-5">
              <input class="form-check-input" type="checkbox" name="colorActive" <%= col.isActive ? 'checked' : '' %> />
              <label class="form-check-label">Active</label>
            </div>
            <div class="col-md-1 text-end">
                <% if (mode === 'edit') { %>
                    <button 
                    type="button" 
                    class="btn btn-sm btn-outline-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteColorModal"
                    data-chair-id="<%= chair._id %>"
                    data-color-id="<%= col._id %>"
                    data-color-name="<%= col.name %>">
                    ✕
                    </button>
                <% } else { %>
                    <button type="button" class="btn btn-sm btn-outline-danger removeColor">✕</button>
                <% } %>
            </div>
          </div>
        <% }); %>
      </div>

      <div class="mt-4 d-flex justify-content-end">
        <button class="btn btn-primary"><%= mode === 'create' ? 'Create' : 'Save Changes' %></button>
      </div>
    </div>
  </form>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteColorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="deleteColorForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to remove the color <strong id="deleteColorName"></strong>?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Yes, Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const deleteModal = document.getElementById('deleteColorModal');
  const deleteForm = document.getElementById('deleteColorForm');
  const deleteColorName = document.getElementById('deleteColorName');

  deleteModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const chairId = button.getAttribute('data-chair-id');
    const colorId = button.getAttribute('data-color-id');
    const colorName = button.getAttribute('data-color-name');

    // Update form action
    deleteForm.action = `/chairs/${chairId}/colors/${colorId}/delete`;
    // Show color name in modal
    deleteColorName.textContent = colorName;
  });
</script>

<script>
  (function(){
    const container = document.getElementById('colorsContainer');
    const addBtn = document.getElementById('addColor');

    addBtn?.addEventListener('click', () => {
      const row = document.createElement('div');
      row.className = 'color-row row g-2 align-items-center';
      row.innerHTML = `
        <div class="col-md-5">
          <input class="form-control" name="colorName" placeholder="Color name" required />
        </div>
        <div class="col-md-4">
          <input class="form-control" name="colorPrice" type="number" step="1" min="0" placeholder="Base price" required />
        </div>
        <div class="col-md-2 form-check ps-5">
          <input class="form-check-input" type="checkbox" name="colorActive" checked />
          <label class="form-check-label">Active</label>
        </div>
        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-sm btn-outline-danger removeColor">✕</button>
        </div>`;
      container.appendChild(row);
    });

    container?.addEventListener('click', (e) => {
      if (e.target.classList.contains('removeColor')) {
        e.target.closest('.color-row')?.remove();
      }
    });
  })();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
