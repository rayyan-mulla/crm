<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Edit Proforma Invoice - <%= pi.piNumber %></title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <style>
    .pi-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 16px;
    }
  </style>
</head>

<body>
<%- include('../partials/navbar', { user, activePage }) %>

<div class="container py-4">

  <h3 class="mb-3">
    Edit Proforma Invoice
    <small class="text-muted fs-6">
      <%= pi.piNumber %> â€” <%= lead.customer_name %>
    </small>
  </h3>

  <form
    action="/leads/<%= lead._id %>/pi/<%= pi._id %>/edit"
    method="post"
    class="card shadow-sm p-4"
  >

    <!-- ================= BILLING ADDRESS ================= -->
    <div class="pi-section mb-4">
      <h5 class="mb-3">Billing Address</h5>

      <div class="row g-3">

        <div class="col-md-4">
          <label class="form-label">Billing Name</label>
          <input class="form-control" name="billing[name]"
                 value="<%= pi.billingAddress?.name || '' %>" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">Phone Number</label>
          <input class="form-control" name="billing[phone]"
                 value="<%= pi.billingAddress?.phone || '' %>"
                 pattern="[0-9]{10}">
        </div>

        <div class="col-md-4">
          <label class="form-label">GSTIN</label>
          <input class="form-control" name="billing[gstin]"
                 value="<%= pi.billingAddress?.gstin || '' %>">
        </div>

        <div class="col-12">
          <label class="form-label">Address Line</label>
          <input class="form-control" name="billing[line1]"
                 value="<%= pi.billingAddress?.line1 || '' %>" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">City</label>
          <input class="form-control" name="billing[city]"
                 value="<%= pi.billingAddress?.city || '' %>" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">State</label>
          <input class="form-control" name="billing[state]"
                 value="<%= pi.billingAddress?.state || '' %>" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">Pincode</label>
          <input class="form-control" name="billing[pincode]"
                 value="<%= pi.billingAddress?.pincode || '' %>">
        </div>

      </div>
    </div>

    <!-- ================= SAME AS BILLING ================= -->
    <div class="form-check mb-4">
      <input class="form-check-input"
             type="checkbox"
             id="sameAsBilling"
             name="sameAsBilling"
             value="true"
             <%= pi.shippingAddress?.line1 === pi.billingAddress?.line1 ? 'checked' : '' %>>
      <label class="form-check-label">
        Shipping address same as billing
      </label>
    </div>

    <!-- ================= SHIPPING ADDRESS ================= -->
    <div class="pi-section mb-4" id="shippingSection">
      <h5 class="mb-3">Shipping Address</h5>

      <div class="row g-3">

        <div class="col-md-6">
          <label class="form-label">Shipping Name</label>
          <input class="form-control" name="shipping[name]"
                 value="<%= pi.shippingAddress?.name || '' %>" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Phone Number</label>
          <input class="form-control" name="shipping[phone]"
                 value="<%= pi.shippingAddress?.phone || '' %>"
                 pattern="[0-9]{10}">
        </div>

        <div class="col-12">
          <label class="form-label">Address Line</label>
          <input class="form-control" name="shipping[line1]"
                 value="<%= pi.shippingAddress?.line1 || '' %>" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">City</label>
          <input class="form-control" name="shipping[city]"
                 value="<%= pi.shippingAddress?.city || '' %>" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">State</label>
          <input class="form-control" name="shipping[state]"
                 value="<%= pi.shippingAddress?.state || '' %>" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">Pincode</label>
          <input class="form-control" name="shipping[pincode]"
                 value="<%= pi.shippingAddress?.pincode || '' %>">
        </div>

      </div>
    </div>

    <!-- ================= GST & OPTIONS ================= -->
    <div class="pi-section mb-4">
      <h5 class="mb-3">GST & Invoice Options</h5>

      <div class="form-check mb-3">
        <input class="form-check-input"
               type="checkbox"
               name="gstEnabled"
               value="true"
               <%= pi.gstEnabled ? 'checked' : '' %>>
        <label class="form-check-label">GST Applicable</label>
      </div>

      <div class="row g-3">

        <div class="col-md-6">
          <label class="form-label">Payment Mode</label>
          <select name="paymentMode" class="form-select">
            <option value="">-- Select --</option>
            <% ['NEFT / RTGS','Cheque','UPI','Cash'].forEach(m => { %>
              <option value="<%= m %>" <%= pi.paymentMode === m ? 'selected' : '' %>>
                <%= m %>
              </option>
            <% }) %>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Estimated Delivery</label>
          <input class="form-control"
                 name="estimatedDelivery"
                 value="<%= pi.estimatedDelivery || '' %>">
        </div>

      </div>

      <div class="mt-3">
        <label class="form-label">Notes (shown on PI)</label>
        <textarea name="notes" class="form-control" rows="3">
<%= pi.notes || '' %></textarea>
      </div>
    </div>

    <!-- ================= ACTIONS ================= -->
    <div class="d-flex justify-content-end">
      <a href="/leads/<%= lead._id %>/pi/history" class="btn btn-secondary me-2">
        Cancel
      </a>
      <button class="btn btn-primary">
        Update Proforma Invoice
      </button>
    </div>

  </form>
</div>

<script>
  const sameChk = document.getElementById('sameAsBilling');
  const shippingSection = document.getElementById('shippingSection');

  function toggleShipping() {
    const inputs = shippingSection.querySelectorAll('input');
    if (sameChk.checked) {
      shippingSection.style.display = 'none';
      inputs.forEach(i => i.disabled = true);
    } else {
      shippingSection.style.display = 'block';
      inputs.forEach(i => i.disabled = false);
    }
  }

  sameChk.addEventListener('change', toggleShipping);
  toggleShipping();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
