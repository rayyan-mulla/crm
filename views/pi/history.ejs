<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PI History - <%= lead.customer_name %></title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
<%- include('../partials/navbar', { user, activePage }) %>

<div class="container py-5">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">Proforma Invoice History</h3>
      <small class="text-muted">
        Lead: <strong><%= lead.customer_name %></strong>
      </small>
    </div>

    <div>
      <a href="/leads/<%= lead._id %>/pi/create" class="btn btn-danger">
        + Generate PI
      </a>
    </div>
  </div>

  <!-- Table -->
  <div class="card shadow-sm">
    <div class="card-body p-0">

      <% if (piHistory.length) { %>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>PI Number</th>
                <th>Date</th>
                <th class="text-end">Taxable</th>
                <th class="text-end">GST</th>
                <th class="text-end">Total</th>
                <th>Status</th>
                <th>Created By</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>

            <tbody>
              <% piHistory.forEach(pi => { 
                const isDeleted = pi.status === 'DELETED';
                const isAdmin = user.role === 'admin';
                const isAssigned =
                  lead.assignedTo &&
                  lead.assignedTo.toString() === user._id.toString();
              %>

                <tr class="<%= isDeleted ? 'text-muted' : '' %>">

                  <td>
                    <%= pi.piNumber %>
                    <% if (isDeleted) { %>
                      <span class="badge bg-danger ms-1">Deleted</span>
                    <% } %>
                  </td>

                  <td>
                    <%= new Date(pi.createdAt).toLocaleDateString('en-IN') %>
                  </td>

                  <td class="text-end">
                    ₹<%= pi.taxableAmount.toLocaleString('en-IN') %>
                  </td>

                  <td class="text-end">
                    ₹<%= pi.gstAmount.toLocaleString('en-IN') %>
                  </td>

                  <td class="text-end">
                    ₹<%= pi.grandTotal.toLocaleString('en-IN') %>
                  </td>

                  <td>
                    <% if (pi.gstType === 'IGST') { %>
                      <span class="badge bg-warning text-dark">IGST</span>
                    <% } else if (pi.gstType === 'CGST_SGST') { %>
                      <span class="badge bg-info">CGST + SGST</span>
                    <% } else { %>
                      <span class="badge bg-secondary">No GST</span>
                    <% } %>
                  </td>

                  <td>
                    <%= pi.createdBy?.fullName || 'System' %>
                  </td>

                  <td class="text-end">
                    <div class="d-flex justify-content-end gap-2">

                      <!-- PDF always allowed -->
                      <a
                        href="/leads/<%= lead._id %>/pi/<%= pi._id %>/pdf"
                        class="btn btn-sm btn-outline-success"
                        target="_blank"
                      >
                        PDF
                      </a>

                      <!-- Edit -->
                      <% if (!isDeleted && (isAdmin || isAssigned)) { %>
                        <a
                          href="/leads/<%= lead._id %>/pi/<%= pi._id %>/edit"
                          class="btn btn-sm btn-outline-primary"
                        >
                          Edit
                        </a>
                      <% } %>

                      <!-- Delete -->
                      <% if (!isDeleted && isAdmin) { %>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-danger"
                          data-bs-toggle="modal"
                          data-bs-target="#deletePiModal"
                          data-pi-id="<%= pi._id %>"
                          data-pi-number="<%= pi.piNumber %>"
                        >
                          Delete
                        </button>
                      <% } %>

                    </div>
                  </td>
                </tr>

              <% }) %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <div class="p-4 text-muted text-center">
          No Proforma Invoices generated for this lead yet.
        </div>
      <% } %>

    </div>
  </div>
</div>

<!-- ================= DELETE PI MODAL ================= -->
<div class="modal fade" id="deletePiModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <form id="deleteForm" method="POST">

        <div class="modal-header">
          <h5 class="modal-title">Delete Proforma Invoice</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p>
            Are you sure you want to delete
            <strong id="deletePiNumber"></strong>?
          </p>

          <div class="mb-3">
            <label class="form-label">Reason for deletion</label>
            <textarea
              name="deleteReason"
              class="form-control"
              rows="3"
              required
              placeholder="Mandatory for audit"
            ></textarea>
          </div>

          <p class="text-muted small mb-0">
            This action cannot be undone.
          </p>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-danger">
            Delete PI
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

<script>
const deleteModal = document.getElementById('deletePiModal');
const deleteForm = document.getElementById('deleteForm');
const deletePiNumber = document.getElementById('deletePiNumber');

deleteModal.addEventListener('show.bs.modal', function (event) {
  const btn = event.relatedTarget;

  const piId = btn.getAttribute('data-pi-id');
  const piNumber = btn.getAttribute('data-pi-number');

  deletePiNumber.textContent = piNumber;
  deleteForm.action = `/leads/<%= lead._id %>/pi/${piId}/delete`;
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
